<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>用户列表</title>
    <script type="text/javascript" src="/static/js/common/pub.js" charset="utf-8"></script>
    <script type="text/javascript" src="/static/js/common/inputSuggest.js" charset="utf-8"></script>
</head>
<body>
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-card">
            <div class="layui-card-header">用户列表</div>
            <div class="layui-card-body">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <button type="button" class="layui-btn layui-btn-warm" id="user_add_modal_btn">
                            <i class="layui-icon">&#xe654;</i>&nbsp;新增
                        </button>
                    </div>
                </div>

                <div class="layui-form" id="userUpdateModal" tabindex="-1" role="dialog" style="display:none;">
                    <form class="form-horizontal" style="margin-top: 30px;">
                        <div class="layui-form-item">
                            <label class="layui-form-label">姓名</label>
                            <div class="layui-input-inline">
                                <input type="text" name="userName" id="userName_update_input" class="layui-input">
                                <span class="help-block"></span>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">身份证</label>
                            <div class="layui-input-inline">
                                <input type="text" name="identityNo" id="identity_update_input" class="layui-input">
                                <span class="help-block"></span>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">邮箱</label>
                            <div class="layui-input-inline">
                                <input type="text" name="email" class="layui-input" id="email_update_input"
                                       placeholder="email@adtec.com.cn">
                                <span class="help-block"></span>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">手机号</label>
                            <div class="layui-input-inline">
                                <input type="text" name="mobile" class="layui-input" id="mobile_update_input">
                                <span class="help-block"></span>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">性别</label>
                            <div class="layui-input-block">
                                <label class="radio-inline">
                                    <input type="radio" name="gender" id="gender1_update_input" value="1"
                                           checked="checked">男
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="gender" id="gender2_update_input" value="0"> 女
                                </label>
                            </div>
                        </div>

                        <div class="layui-form-item">
                            <label class="layui-form-label">公司</label>
                            <div class="layui-input-block">
                                <select id="companySelectUpdate" name="companyId" class="layui-input">
                                    <option value="">请选择</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">部门</label>
                            <div class="layui-input-block">
                                <select id="deptSelectUpdate" class="layui-input" name="deptId">
                                    <option value="">请选择</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">角色</label>
                            <div class="layui-input-block">
                                <select id="roleSelectUpdate" class="layui-input" name="roleId">
                                    <option value="">请选择</option>
                                </select>
                            </div>
                        </div>
                    </form>
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button type="button" id="user_update_btn" class="btn btn-primary">更新</button>
                        </div>
                    </div>
                </div>

                <div class="layui-form" id="userAddModal" lay-filter="userAddModal" tabindex="-1" role="dialog" style="display:none;">
                    <form class="form-horizontal" style="margin-top: 30px;">
                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <input type="text" style="display:none" name="neweqptIdCode" id="SYS_CODE1" required
                                       lay-verify="required" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">姓名</label>
                            <div class="layui-input-inline">
                                <input type="text" name="userName" id="userName_add_input" class="layui-input">
                                <span class="help-block"></span>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">身份证</label>
                            <div class="layui-input-inline">
                                <input type="text" name="identityNo" id="identity_add_input" class="layui-input">
                                <span class="help-block"></span>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">邮箱</label>
                            <div class="layui-input-inline">
                                <input type="text" name="email" class="layui-input" id="email_add_input"
                                       placeholder="email@adtec.com.cn">
                                <span class="help-block"></span>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">手机号</label>
                            <div class="layui-input-inline">
                                <input type="text" name="mobile" class="layui-input" id="mobile_add_input">
                                <span class="help-block"></span>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">密码</label>
                            <div class="layui-input-inline">
                                <input type="password" name="originalPassword" class="layui-input"
                                       id="password_add_input"
                                       onkeydown="return noBlank(event)">
                                <span class="help-block" id="lastBlock"></span>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">性别</label>
                            <div class="layui-input-block">
                                <input type="radio" name="gender" title="男" id="gender1_add_input" value="1"
                                       checked="checked">
                                <input type="radio" name="gender" title="女" id="gender2_add_input" value="0">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">公司</label>
                            <div class="layui-input-block">
                                <select id="companySelectAdd" name="companyId" class="layui-input">
                                    <option value="">请选择</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">部门</label>
                            <div class="layui-input-block">
                                <select id="deptSelectAdd" class="layui-input" name="deptId">
                                    <option value="">请选择</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">角色</label>
                            <div class="layui-input-block">
                                <select id="roleSelectAdd" class="layui-input" name="roleId">
                                    <option value="">请选择</option>
                                </select>
                            </div>
                        </div>
                    </form>
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button type="button" id="user_save_btn" class="btn btn-primary">保存</button>
                        </div>
                    </div>
                </div>
                <table id="userMana" class="layui-table" lay-filter="userManaEvent"></table>
            </div>
        </div>
    </div>
</div>

<script type="text/html" id="toolbar">
    <a class="layui-btn layui-btn-xs " lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs " lay-event="del">删除</a>
</script>

<script type="text/javascript">

    layui.use(['form', 'layedit', 'laydate', 'laypage', 'table'], function () {
        var form = layui.form
            , layer = layui.layer
            , laypage = layui.laypage
            , layedit = layui.layedit
            , table = layui.table;

        let totalRecord, currentPage;


        laypage.render({
            curr: 1 //设定初始在第 1 页
            , limit: 10//每页显示条数
            , groups: 5 //只显示 5 个连续页码
            , layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip']
            , jump: function (obj) {
                let page = obj.curr;
                let limit = obj.limit;
                search(page, limit);
            }
        })

        function search(page, limit) {
            table.render({
                elem: '#userMana'
                , url: '/user/getUsers' //数据接口
                // , where: {roleType: "01"}
                , page: {
                    layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip']
                    , curr: page //设定初始在第 1 页
                    , limit: limit
                    , groups: 5 //只显示 5 个连续页码
                }
                , cols: [[ //表头
                    {field: 'userId', hide: true}
                    ,{field: 'userName', title: '姓名', width: 150}
                    , {
                        field: 'gender', title: '性别', width: 135, templet: function (d) {
                            return d.gender == 0 ? "女" : "男"
                        }
                    }
                    , {field: 'email', title: '邮箱', width: 310}
                    , {field: 'roleName', title: '角色', align: 'center', width: 110}
                    , {field: 'mobile', title: '手机号', align: 'center', width: 190}
                    , {field: 'dosomething', title: '操作', id: 'hide', align: 'center', toolbar: '#toolbar'}
                ]]
                , response: {
                    statusName: 'code'
                    , statusCode: '100'
                    , msgName: 'msg'
                    , countName: 'total'
                    , dataName: 'data'
                }
            });
        }

        table.on('tool(userManaEvent)', function (obj) {
            var data = obj.data;
            if (obj.event === 'del') {
                deleteUserInfo(data.userId, data.userName, data.userRoleId);
            } else if (obj.event === 'edit') {
                console.log(data);
                openEditModal(data.userId);
            }
        });


        let index_open_add;
        //点击新增按钮弹出模态框。
        $("#user_add_modal_btn").click(function () {
            index_open_add = layer.open({
                //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                type: 1,
                title: "用户新增",
                area: ['600px', '700px'],
                content: $("#userAddModal")
            })

            //清除表单数据（表单完整重置（表单的数据，表单的样式））
            reset_form("#userAddModal form");
            //s$("")[0].reset();
            getEmilEnd();
            //发送ajax请求，查出角色信息，显示在下拉列表中
            getRoles("#userAddModal #roleSelectAdd");
            //发送ajax请求，查出公司信息，显示在下拉列表中
            getCompanys("#userAddModal #companySelectAdd");
            //根据公司信息，查询出部门信息显示在下拉列表中
            getDepts("#userAddModal #deptSelectAdd");
            form.render();
        });

        //单个删除
        function deleteUserInfo(userId, userName, userRoleId) {
            layer.confirm("确认删除【" + userName + "】吗？", {icon: 3, title: '确认信息'}, function (index) {
                //确认，发送ajax请求删除即可
                $.ajax({
                    url: "/user/delete/" + userId + "/" + userRoleId,
                    type: "DELETE",
                    success: function (result) {
                        layer.msg(result.msg, {time: 2000});
                        //回到本页
                        to_page();
                    }
                });
            })
        };


        let index_open_update;

        function openEditModal(id) {

            form.val("userAddModal", {});
            //清空表单样式
            $('#userUpdateModal form').find("*").removeClass("has-error has-success");
            $('#userUpdateModal form').find(".help-block").text("");
            /*在这里设置模态框并打开.*/
            index_open_update = layer.open({
                //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                type: 1,
                title: "用户修改",
                area: ['600px', '700px'],
                content: $("#userUpdateModal")
            });

            //加载角色列表下拉框
            getRoles("#userUpdateModal #roleSelectUpdate");
            //加载公司列表下拉框
            getCompanys("#userUpdateModal #companySelectUpdate");
            //查出用户信息，显示用户信息
            getUser(id);
            //3、把员工的id传递给模态框的更新按钮
            $("#user_update_btn").attr("edit-id", id);
            form.render();
        };


        //新增部门根据公司改变而改变
        $("#companySelectAdd").change(function () {
            $("#deptSelectAdd").empty();
            var companyId = $("#companySelectAdd").val();
            $.ajax({
                url: "/department/getDepartmentsByCompanyId",
                data: {companyId: companyId},
                type: "POST",
                async: false,
                success: function (result) {
                    //显示部门信息在下拉列表中
                    $.each(result.extend.depts, function () {
                        var optionEle = $("<option></option>").append(this.deptName).attr("value", this.deptId);
                        optionEle.appendTo($("#deptSelectAdd"));
                    });
                }
            });
            form.render();
        })

        //修改的部门根据公司改变而改变
        $("#companySelectUpdate").change(function () {
            $("#deptSelectUpdate").empty();
            var companyId = $("#companySelectUpdate").val();
            $.ajax({
                url: "/department/getDepartmentsByCompanyId",
                data: {companyId: companyId},
                type: "POST",
                async: false,
                success: function (result) {
                    //显示部门信息在下拉列表中
                    $.each(result.extend.depts, function () {
                        var optionEle = $("<option></option>").append(this.deptName).attr("value", this.deptId);
                        optionEle.appendTo($("#deptSelectUpdate"));
                    });
                }
            });
            form.render();
        })

        //校验邮箱是否可用
        $("#email_add_input").change(function () {
            //发送ajax请求校验邮箱是否可用
            var email = this.value;
            $.ajax({
                url: "/user/userCheck",
                data: "email=" + email,
                type: "POST",
                success: function (result) {
                    if (result.code == "100") {
                        show_validate_msg("#email_add_input", "success", "邮箱可用");
                        $("#user_save_btn").attr("ajax-va", "success");
                    } else {
                        show_validate_msg("#email_add_input", "error", result.extend.va_msg);
                        $("#user_save_btn").attr("ajax-va", "error");
                        return false;
                    }
                }
            });
        });

        //修改校验邮箱是否可用
        $("#email_update_input").change(function () {
            //发送ajax请求校验邮箱是否可用
            var email = this.value;
            var hideEmail = $("#hideEmail").html();
            $.ajax({
                url: "/user/userCheck",
                data: "email=" + email,
                type: "POST",
                success: function (result) {
                    if (result.code == "100") {
                        show_validate_msg("#email_update_input", "success", "邮箱可用");
                        $("#user_update_btn").attr("ajax-va", "success");
                    } else {
                        if (hideEmail == email) {
                            show_validate_msg("#email_update_input", "success", "邮箱可用");
                            $("#user_update_btn").attr("ajax-va", "success");
                        } else {
                            show_validate_msg("#email_update_input", "error", result.extend.va_msg);
                            $("#user_update_btn").attr("ajax-va", "error");
                        }
                    }
                }
            });
        });

        //点击保存，保存员工。
        $("#user_save_btn").click(function () {

            if (!validate_add_form()) {
                return false;
            }
            ;
            //1、判断之前的ajax邮箱校验是否成功。如果成功。
            if ($(this).attr("ajax-va") == "error") {
                show_validate_msg("#email_add_input", "error", "邮箱不可用");
                return false;
            }
            var originalPassword = $("#password_add_input").val();
            //2、发送ajax请求保存员工
            $.ajax({
                url: "/user/save",
                type: "POST",
                data: $("#userAddModal form").serialize() + "&password=" + originalPassword,
                success: function (result) {
                    if (result.code == "100") {
                        layer.msg("新增成功!", {time: 2000});
                        layer.close(index_open_add);
                        to_page(totalRecord);

                    } else {
                        //有哪个字段的错误信息就显示哪个字段的；
                        if (undefined != result.extend.errorFields.email) {
                            //显示邮箱错误信息
                            show_validate_msg("#email_add_input", "error", result.extend.errorFields.email);
                        }
                        if (undefined != result.extend.errorFields.empName) {
                            //显示用户名字的错误信息
                            show_validate_msg("#userName_add_input", "error", result.extend.errorFields.userName);
                        }
                    }
                }
            });
        });

        //点击更新，更新员工信息
        $("#user_update_btn").click(function () {
            //1、拿到要校验的数据，使用正则表达式
            var userName = $("#userName_update_input").val();
            var regName = /(^[a-zA-Z0-9_-]{6,16}$)|(^[\u2E80-\u9FFF]{2,5})/;
            if (!regName.test(userName)) {
                //alert("用户名可以是2-10位中文或者6-10位英文和数字的组合");
                show_validate_msg("#userName_update_input", "error", "用户名可以是2-10位中文或者6-10位英文和数字的组合");
                return false;
            } else {
                show_validate_msg("#userName_update_input", "success", "");
            }
            ;

            //2、校验邮箱信息
            var email = $("#email_update_input").val();
            var regEmail = /^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$/;
            if (!regEmail.test(email)) {
                //alert("邮箱格式不正确");
                //应该清空这个元素之前的样式
                show_validate_msg("#email_update_input", "error", "邮箱格式不正确");
                return false;
            } else {
                show_validate_msg("#email_update_input", "success", "");
            }


            //1、判断之前的ajax邮箱校验是否成功。如果成功。
            if ($(this).attr("ajax-va") == "error") {
                show_validate_msg("#email_update_input", "error", "邮箱不可用");
                return false;
            }
            //2、发送ajax请求保存更新的员工数据
            $.ajax({
                url: "/user/update/" + $(this).attr("edit-id"),
                type: "PUT",
                data: $("#userUpdateModal form").serialize(),
                success: function (result) {
                    if (result.code == "100") {
                        layer.msg("更新成功!", {time: 2000});
                        layer.close(index_open_update);
                        to_page(currentPage);
                    } else {
                        layer.msg("更新失败!", {time: 2000});
                    }
                }
            });
        });

        function to_page() {
            //调用分页
            laypage.render({
                curr: 1 //设定初始在第 1 页
                , limit: 10//每页显示条数
                , groups: 5 //只显示 5 个连续页码
                , layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip']
                , jump: function (obj) {
                    var page = obj.curr;
                    var limit = obj.limit;
                    search(page, limit);
                }
            })
        }
    });

    function getEmilEnd() {
        new InputSuggest({
            opacity: 1,
            input: document.getElementById('email_add_input'),
            data: ['adtec.com.cn']
        });
    }


    //清空表单样式及内容
    function reset_form(ele) {
        $(ele)[0].reset();
        //清空表单样式
        $(ele).find("*").removeClass("has-error has-success");
        $(ele).find(".help-block").text("");
    }


    //查出所有的角色信息并显示在下拉列表中
    function getRoles(ele) {
        //清空之前下拉列表的值
        $(ele).empty();
        $.ajax({
            url: "/role/getSpecificRoles",
            data: {roleType: "00"},
            type: "POST",
            async: false,
            success: function (result) {
                //显示角色信息在下拉列表中
                $.each(result.data, function () {
                    var optionEle = $("<option></option>").append(this.roleName).attr("value", this.roleId);
                    optionEle.appendTo(ele);
                });
            }
        });
    }

    //查出所有的公司信息并显示在下拉列表中
    function getCompanys(ele) {
        //清空之前下拉列表的值
        $(ele).empty();
        $.ajax({
            url: "/company/getAllCompany",
            type: "POST",
            async: false,
            success: function (result) {
                //显示角色信息在下拉列表中
                $.each(result.extend.AllCompany, function () {
                    var optionEle = $("<option></option>").append(this.companyName).attr("value", this.companyId);
                    optionEle.appendTo(ele);
                });
            }
        });
    }

    //查出所属公司的所有部门信息并显示在下拉列表中
    function getDepts(ele) {
        //清空之前下拉列表的值
        $(ele).empty();
        if (ele.toString().indexOf("SelectAdd") > 0) {
            var companyId = $("#companySelectAdd").val();
        } else {
            var companyId = $("#companySelectUpdate").val();
        }
        $.ajax({
            url: "/department/getDepartmentsByCompanyId",
            data: {companyId: companyId},
            type: "POST",
            async: false,
            success: function (result) {
                //显示部门信息在下拉列表中
                $.each(result.extend.depts, function () {
                    var optionEle = $("<option></option>").append(this.deptName).attr("value", this.deptId);
                    optionEle.appendTo(ele);
                });
            }
        });
    }

    //校验表单数据
    function validate_add_form() {
        //1、拿到要校验的数据，使用正则表达式
        var userName = $("#userName_add_input").val();
        var regName = /(^[a-zA-Z0-9_-]{6,10}$)|(^[\u2E80-\u9FFF]{2,10})/;
        if (!regName.test(userName)) {
            show_validate_msg("#userName_add_input", "error", "用户名可以是2-10位中文或者6-10位英文和数字的组合");
            return false;
        } else {
            show_validate_msg("#userName_add_input", "success", "");
        }
        ;

        //2、校验邮箱信息
        var email = $("#email_add_input").val();
        var regEmail = /^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$/;
        if (!regEmail.test(email)) {
            //alert("邮箱格式不正确");
            //应该清空这个元素之前的样式
            show_validate_msg("#email_add_input", "error", "邮箱格式不正确");
            return false;
        } else {
            show_validate_msg("#email_add_input", "success", "");
        }

        //3、校验密码
        var password = $("#password_add_input").val();
        var regPassword = /^[A-Za-z]+[0-9]+[A-Za-z0-9]*|[0-9]+[A-Za-z]+[A-Za-z0-9]*$/g;
        if (!regPassword.test(password)) {
            //alert("邮箱格式不正确");
            //应该清空这个元素之前的样式
            show_validate_msg("#password_add_input", "error", "密码必须由6-16位英文字母和数字的字符串组成!");
            return false;
        } else {
            show_validate_msg("#password_add_input", "success", "");
        }

        return true;
    }

    //显示校验结果的提示信息
    function show_validate_msg(ele, status, msg) {
        //清除当前元素的校验状态
        $(ele).parent().removeClass("has-success has-error");
        $(ele).next("span").text("");
        if ("success" == status) {
            $(ele).parent().addClass("has-success");
            $(ele).next("span").text(msg);
        } else if ("error" == status) {
            $(ele).parent().addClass("has-error");
            $(ele).next("span").text(msg);
        }
    }

    function getUser(id) {
        $.ajax({
            url: "/user/selectUserById",
            data: {id: id, roleType: ""},
            type: "POST",
            async: false,
            success: function (result) {
                var userData = result.extend.user
                var hideEmail = result.extend.user.email
                $("#userName_update_input").val(userData.userName);
                $("#email_update_input").val(userData.email);
                $("#hideEmail").remove();
                // $("#roleSelectUpdate").after($("<span></span>").attr("id", "hideEmail").html(hideEmail));
                $("#hideEmail").hide();
                $("#userUpdateModal input[name=identityNo]").val(userData.identityNo);
                $("#userUpdateModal input[name=gender]").val(userData.gender);
                $("#userUpdateModal input[name=mobile]").val(userData.mobile);
                $("#userUpdateModal input[name=password]").val(userData.password);
                $("#roleSelectUpdate").val(userData.roleId);
                $("#companySelectUpdate").val(userData.companyId);
                //根据公司信息，查询出部门信息显示在下拉列表中
                getDepts("#userUpdateModal #deptSelectUpdate");
                $("#deptSelectUpdate").val(userData.deptId);
            }
        });
    }

    //输入框密码不能输入空格
    function noBlank(e) {
        var keynum;
        var keychar;
        var numcheck;

        if (window.event) // IE
        {
            keynum = e.keyCode
        } else if (e.which) // Netscape/Firefox/Opera
        {
            keynum = e.which
        }
        keychar = String.fromCharCode(keynum);
        numcheck = /\s+/g;
        return !numcheck.test(keychar);
    }

</script>
</body>
</html>